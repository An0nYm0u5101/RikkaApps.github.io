# 用语解释

* 内置存储：设备的内置存储，如 `/storage/emulated/<user id>`（user id 一般是 0，即主用户）
* （内置存储）根目录：如 `/storage/emulated/0` 这个文件夹
* （内置存储上的）应用专用文件夹：Android 系统设计的应用专用的的文件夹，如 `/storage/emulated/0/Android/data/com.example`（其中 `com.example 是应用包名）
* 重定向目标文件夹：每个被重定向应用都有的选项，是应用专用文件夹中的一个文件夹
* 非重定向文件夹：每个被重定向应用都有的选项，是一组文件夹

# 我们的理念

我们希望，应用应该只能在用户可以感知的情况下，在内置存储中（除了应用专用文件夹）保存**对用户有用的文件**（比如用户在聊天应用中保存收到的图片，在浏览器中下载文件）。

但很多应用（尤其是大多数来自中国大陆的应用），或是主动或是被动地（使用的某些 SDK 的行为）在内置存储创建很多文件夹，那些文件大多为私有格式的数据，**这些文件应该被存放至应用专用文件夹**。卸载那些应用后，那些文件也不会被删除。我们认为这样的行为是不可接受的。

“存储重定向”以**在对正常使用体验造成最小影响的前提下，让应用行为如我们所希望**为理念设计。

# 从零开始的教程

## 了解开启重定向会发生什么

在开启了重定向后，当应用读取/写入内置存储中的文件时，实际会读写“重定向目标文件夹”中的文件，这样内置存储就不会受到污染。但这样应用就会无法访问一些需要的文件（如聊天应用访问照片），因此引入了“非重定向文件夹”，应用可以正常读写其中的文件。

你还可以借助“查看重定向存储”功能来以被重定向的应用的视角观察内置存储。

另外，这个应用产生的文件，只要不是在“非重定向文件夹”文件夹中，都会受到 Android 系统管理。你可以在系统的应用信息中查看到这些文件所占的空间，当你清除应用数据或是卸载应用时，这些文件也会被删除。

## 了解可能影响应用正常使用的情况

会影响应用正常的情况基本都是涉及多个应用交互的情况。

简单的说，一个文件路径，对于开启和没有开启重定向的应用，或是不同的开启了重定向的应用，可能会对应到不同的文件。
所以如果这些应用如果传递文件路径而非使用 `Content Provider` 就会产生问题。

可以分为这几类：

1. 从被重定向的应用使用其他应用打开文件（通过“链接”功能变通解决，未来会通过“增强模块”完美解决）
2. 从被重定向应用分享文件到其他应用
3. 从其他应用分享文件到被重定向的应用
4. 被重定向应用在希望被重定向的文件夹创建的文件会被其他被重定向应用使用（通过“共享文件夹”功能解决）
5. 被重定向应用无法在特定文件夹间移动文件（通过“增强模块”解决）

一些中国大陆地区用户经常会遇到的实际问题：

* 从 QQ, WeChat 打开收到的文件 (1)
* 搜狗拼音直接发送图片到 QQ (4)
* 修改 WeChat 的 Xposed 模块配置失效 (4)
* Bilibili 无法保存录制的视频 gif (5)

需要注意的是，这些问题（除了 5）通常只会出现在设计不佳的应用上，所以随着时间推移，有问题的情况应该会越来越少。

## 判断是否需要重定向

如果一个应用会创建令你不快的文件，且不提供选项可以更改，那就可以判断为应该开启重定向。

如果使用了“增强模块”，可以由文件监控功能查看应用访问了什么位置的文件，进而推测出文件是由什么应用创建。

## 重定向相关选项

### 非重定向文件夹

非重定向文件夹是一个非常重要的选项，它决定被重定向的应用可以访问什么文件夹中的文件。
如果你发现无法在应用中找到某些文件，那你需要检查那些文件是不是处于非重定向文件夹文件夹中。
你还可以借助“查看重定向存储”功能来确认应用能否访问那些文件。

### 重定向目标文件夹

重定向目标文件夹是一个不太重要的选项，它决定应用读写“非重定向文件夹”以外的文件夹是实际读写的文件夹。如果没有特殊需求，通常没有必要更改。

### 链接

链接是一个非常重要的部分。如果你充分理解了开启重定向后会发生什么，那你一定会猜到，如果被重定向的应用保存了有用的文件到“非重定向文件夹”以外的文件夹，那其他应用很可能不能找到这些文件。链接功能就是为了解决这个问题而生。

你可以简单的把一个链接规则理解成，让重定向存储中的某个文件夹与内置存储中更外层的某个文件夹中的文件保持同步，这样你就可以直接在外层的文件夹中找到那些文件。

有在线规则的应用通常会包含链接规则，大部分时候直接开启那些规则就足够。但需要注意，规则由其他用户提供，其正确性和时效性可能无法保证。因此我们还是更希望你能够了解链接功能如何工作，并在在线规则不能满足自己的需求时能创建甚至是向其他用户贡献自己的规则。

另外链接功能的链接文件行为使用硬链接（你可以自己搜索什么是硬链接），源文件夹和目标文件夹中能看到的相同的文件只会占用一份存储空间。

#### 如何建立自己的链接规则

首先强调一点，链接功能应该只用来链接有用的文件（如聊天软件中保存的图片和文档等）。部分人会误认为应用产生的各种文件都需要链接，如果是这样的话重定向就失去了意义。

以 WeChat 为例，WeChat 会将接收到的文件保存至 `tencent/MicroMsg/WeChat` (首次打开 WeChat 语言是简体中文时为 `tencent/MicroMsg/WeiXin`，后面不再额外说明)，如果开启了重定向则实际会保存至 `Android/data/com.tencent.mm/sdcard/tencent/MicroMsg/WeChat`，这样找到其中的文件就会非常不方便。因此我们就需要建立连接链接规则，链接这些文件到更外面的文件夹。

我们可以先简单建立这样的链接规则：

* 来源路径：`tencent/MicroMsg/WeChat`
* 目的路径：`Download/WeChat`

接着收到的文件就会被保存到 `Download/WeChat`，但接着你肯定会发现一些问题。

1. 接收的图片在相册应用中找不到

   打开“添加到媒体存储”选项即可

2. “用其他应用打开”并不能正常打开文件
  
   这是因为 WeChat 没有使用 `Content Provider`。这个问题目前只有一种变通的解决方法，就是“显示通知”选项。当勾上“显示通知”后并再次收到文件时会额外看到一条“已下载 xxx”的通知，点击这个通知就可以正常打开文件。
   
   此外你还可以借助其他文件管理应用或是 Android 的文档应用直接找到这些文件。

3. 出现了一些不需要的文件

   WeChat 还会**可能**把另一些文件 (com.tencent.xin.emoticon 开头) 存放到 `tencent/MicroMsg/WeChat`，但我们并不需要在外面访问这些文件，因此需要借助“过滤”选项排除这些文件。

   “过滤”功能使用正则表达式，你可以自己搜索学习正则表达式。

### 共享文件夹

共享文件夹是 v1.2.0 版本起添加的非常重要部分。简单的说，共享文件夹可以让一个被重定向的应用访问另一个被重定向的应用产生的文件。

### 开启重定向之后需要做的事情

#### 转移和删除应用以前创建的文件

因为内置存储中的文件无法追踪创建者，所以你需要自行移动和删除应用以前创建的文件们。
