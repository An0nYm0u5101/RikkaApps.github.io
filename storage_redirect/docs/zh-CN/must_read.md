# 声明

“存储重定向”不可能做到完全无门槛，因此我们希望你至少是能够认真阅读帮助的人。

# 从零开始的教程

这里先确定几个概念：

* 内置存储：手机的内置存储，如 `/storage/emulated/<user id>`（user id 一般是 0，即主用户）
* （内置存储）根目录：如 `/storage/emulated/0` 这个文件夹
* （内置存储上的）应用专用文件夹：应用专用的的文件夹，如`/storage/emulated/0/Android/data/com.example`（其中 com.example 是应用包名）
* 重定向目标文件夹：每个被重定向应用都有的选项，是应用专用文件夹中的一个文件夹
* 非重定向文件夹：每个被重定向应用都有的选项，是一组文件夹

### 了解开启重定向会发生什么

在开启了重定向后，对被重定向的应用来说根目录将是另外的文件夹。
当应用读取/写入内置存储中的文件时，实际会读写“重定向目标文件夹”中的文件，这样内置存储就不会受到污染。
为了让应用能正常访问一些必要的文件（如聊天应用访问照片），引入了“非重定向文件夹”，应用可以正常读写其中文件。

你还可以借助“查看重定向存储”功能来以被重定向的应用的视角观察内置存储。

另外，这个应用产生的文件，只要不是在“非重定向文件夹”文件夹中，都会受到 Android 系统管理。
你可以在系统的应用信息中查看到这些文件所占的空间，当你清除应用数据或是卸载应用时，这些文件也会被删除。

### 了解可能影响应用正常使用的情况

会影响应用正常的情况基本都是涉及多个应用交互的情况。

简单的说，一个文件路径，对于开启和没有开启重定向的应用，或是不同的开启了重定向的应用，可能会对应到不同的文件。
所以如果这些应用如果传递文件路径而非使用 `Content Provider` 就会产生问题。

一些实际情况：

* 从被重定向的应用打开文件（可以通过下面的链接功能变通解决）
* 从被重定向应用分享文件到其他应用
* 从其他应用分享文件到被重定向的应用
* 一个应用在内置存储中创建的文件会被其他应用使用（未来会提供解决方案）

需要注意的是，这些问题通常只会出现在设计不完全的应用上，所以随着时间推移，有问题的情况应该会越来越少。

### 判断是否需要重定向

如果一个应用会创建令你不快的文件，且不提供选项可以更改，那就可以判断为应该开启重定向。

如果使用了“增强模块”，可以由文件监控功能查看应用访问了什么位置的文件，进而推测出文件是由什么应用创建。

### 重定向相关选项

#### 非重定向文件夹

非重定向文件夹是一个非常重要的选项，它决定被重定向的应用可以访问什么文件夹中的文件。
如果你发现无法在应用中找到某些文件，那你需要检查那些文件是不是处于非重定向文件夹文件夹中。
你还可以借助“查看重定向存储”功能来确认应用能否访问那些文件。

#### 重定向目标文件夹

重定向目标文件夹是一个不太重要的选项，如果没有特殊需求，通常没有必要更改。

#### 链接

链接是一个非常重要的部分。如果你充分理解了开启重定向后会发生什么，那你一定会猜到，
如果被重定向的应用保存了有用的文件到“非重定向文件夹”以外的文件夹，那其他应用将不能找到这些文件。
链接功能就是为了解决这个问题而生。

你可以简单的把一个链接规则理解成，让重定向存储中的某个文件夹与内置存储中更外层的某个文件夹中的文件保持同步，这样你就可以直接在外层的文件夹中找到那些文件。

有在线规则的应用通常会包含链接规则，大部分时候直接开启那些规则就足够。但需要注意，规则由其他用户提供，其正确性和时效性无法保证。
因此我们还是更希望你能够了解链接功能如何工作，并在在线规则不能满足自己的需求时能创建甚至是向其他用户贡献自己的规则。

首先强调一点，链接功能应该只用来链接有用的文件（如聊天软件中保存的图片）。
部分人可能会产生误区，认为应用产生的各种文件夹都需要链接，如果是这样的话重定向就失去了意义。

一条链接规则主要包括源文件夹和目标文件夹。而链接功能的本质就是监控这两个文件夹，并根据规则做出以下的行为：

* 源文件夹中新文件创建：链接至目标文件夹
* 源文件夹中文件被删除：删除目标文件夹中对应文件（仅限应用在前台运行）
* 目标文件夹中文件被删除：删除目标文件夹中对应文件
* 开启规则（及每次开机）时，目标文件夹中的文件将会被链接至源文件夹

另外链接功能的链接文件行为使用硬链接（你可以自己搜索什么是硬链接），所以源文件夹和目标文件夹中能看到的相同的文件只会占用一份存储空间。

### 开启重定向之后需要做的事情

#### 转移和删除应用以前创建的文件

因为内置存储中的文件无法追踪创建者，所以你需要自行移动和删除应用以前创建的文件们。
