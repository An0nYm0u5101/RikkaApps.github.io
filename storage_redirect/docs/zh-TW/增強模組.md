# 增強模組

## 功能

* 開機時保證 _儲存重新導向_  早於普通程式啟動
* 保證重新導向一定會在被重新導向的程式本身的邏輯之前執行
* 監控公共儲存空間檔案訪問（僅限程式進程調用 `libc` 裡的 `open open64 openat openat64 creat creat64 mkdir mkdirat`）
* 修復被重新導向程式無法在特定資料夾間移動檔案的問題

## 注意事項

* 使用前備份你的全部資料
* 出現任何問題，請嘗試停用（刪除）模組

## 安装

_由於該方案需要取代系統檔案，我們暫時只提供 Magisk 模組。_

### 藉助 [Magisk](https://forum.xda-developers.com/apps/magisk/official-magisk-v7-universal-systemless-t3473445) 安裝（推薦）

重要：安裝前**請務必確認已經瞭解如何在無法進入系統時刪除模組**

從 v13 開始，增強模組是 [Riru](https://github.com/RikkaApps/Riru) 模組，所以你需要安裝多個 zip。

1. 重要：**刪除 v12 或更早的模組（如果有）**
2. 重要：保證 儲存重新導向 版本是 **1.0.0.r1083 或以上**
3. 保證 Magisk 版本是 v17 或以上
4. 下載 [[Magisk] Riru - Core v9 for arm/arm64](https://github.com/RikkaApps/Riru/releases/download/v9/magisk-riru-core-arm-arm64-v9.zip)
5. 下載 [[Magisk] Riru - Storage Redirect v15 for arm/arm64](https://github.com/RikkaApps/StorageRedirect-assets/releases/download/assets/magisk-riru-storage-redirect-arm-arm64-v15.zip)
6. 在 _Magisk Manager_ 中安裝
   
## 如何確認已經起作用

* 開機過程中，觀察有沒有 `StorageRedirectInject: replaced com.android.internal.os.Zygote#nativeForkAndSpecialize` 的 log（由於會在非常早期的啟動過程中被觸發，必須連接電腦使用 adb 才可能看到）
* 當開啟任意程式時，觀察是否有如 `StorageRedirectInject: nativeForkAndSpecialize called, uid=` 的 log（任何可以讀 log 的東西都可以）
